rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function hasAllowedDomain() {
      return request.auth.token.email != null
        && request.auth.token.email.matches('.*@forcs\\.com$');
    }

    function accessRequestPath(uid) {
      return /databases/$(database)/documents/access_requests/$(uid);
    }

    function hasAccessRequest(uid) {
      return exists(accessRequestPath(uid));
    }

    function accessRequest(uid) {
      return get(accessRequestPath(uid));
    }

    function getAccessRole(uid) {
      return accessRequest(uid).data.role;
    }

    function getAccessTeamId(uid) {
      return accessRequest(uid).data.teamId;
    }

    function hasAllowedHeadquarter() {
      return hasAccessRequest(request.auth.uid)
        && accessRequest(request.auth.uid).data.hqId == 'hq-cloud';
    }

    function isApprovedUser() {
      return isSignedIn()
        && hasAllowedDomain()
        && hasAccessRequest(request.auth.uid)
        && accessRequest(request.auth.uid).data.status == 'approved';
    }

    function isApprover() {
      return isApprovedUser()
        && hasAllowedHeadquarter()
        && getAccessRole(request.auth.uid) == 'TEAM_LEADER';
    }

    function isSuperAdmin() {
      return isApprovedUser()
        && getAccessRole(request.auth.uid) == 'SUPER_ADMIN';
    }

    function isAdmin() {
      return isApprovedUser()
        && getAccessRole(request.auth.uid) in ['SUPER_ADMIN', 'HQ_LEADER', 'TEAM_LEADER'];
    }

    function isTrustedUser() {
      return isSignedIn() && hasAllowedDomain() && isApprovedUser() && hasAllowedHeadquarter();
    }

    function isBootstrapSuperAdmin() {
      return isSignedIn()
        && request.auth.token.email == 'rayben@forcs.com';
    }

    match /access_requests/{userId} {
      allow create: if isSignedIn()
        && hasAllowedDomain()
        && request.auth.uid == userId
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.email == request.auth.token.email
        && request.resource.data.keys().hasOnly([
          'uid',
          'email',
          'displayName',
          'status',
          'role',
          'hqId',
          'teamId',
          'partId',
          'createdAt',
          'updatedAt'
        ])
        && (
          request.resource.data.status == 'pending'
          || (isBootstrapSuperAdmin()
            && request.resource.data.status == 'approved'
            && request.resource.data.role == 'SUPER_ADMIN'
          )
        );
      allow read: if isApprover()
        || isSuperAdmin()
        || (isSignedIn() && hasAllowedDomain() && request.auth.uid == userId);
      allow update: if (
        isSuperAdmin()
        || (isApprover() && (request.resource.data.status == 'rejected' || request.resource.data.teamId == getAccessTeamId(request.auth.uid)))
        || (isBootstrapSuperAdmin() && request.auth.uid == userId)
      )
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.email == resource.data.email
        && request.resource.data.keys().hasOnly([
          'uid',
          'email',
          'displayName',
          'status',
          'role',
          'hqId',
          'teamId',
          'partId',
          'createdAt',
          'updatedAt',
          'approvedAt',
          'approvedBy',
          'approvedByEmail',
          'rejectedAt',
          'rejectedBy',
          'rejectedByEmail'
        ]);
      allow delete: if false;
    }

    // 팀 컬렉션
    match /teams/{teamId} {
      allow read: if isTrustedUser();
      allow write: if isAdmin();
    }

    // 멤버 컬렉션
    match /members/{memberId} {
      allow read: if isTrustedUser();
      allow write: if isAdmin();
    }

    // 평가 템플릿 컬렉션 (신규/기존 호환)
    match /templates/{templateId} {
      allow read: if isTrustedUser();
      allow write: if isAdmin();
    }

    match /evaluation_templates/{templateId} {
      allow read: if isTrustedUser();
      allow write: if isAdmin();
    }

    // 설정 컬렉션 (카테고리 등)
    match /settings/{documentId} {
      allow read: if isTrustedUser();
      allow write: if isAdmin();
    }

    // 캠페인(평가) 컬렉션: 코드에서 evaluation_campaigns 사용
    match /evaluation_campaigns/{evaluationId} {
      allow read: if isTrustedUser();
      allow create, update, delete: if isAdmin();

      // 평가 응답 (하위 컬렉션으로 존재하는 경우)
      match /responses/{userId} {
        allow read, write: if isTrustedUser() && (isAdmin() || request.auth.uid == userId);
      }
    }

    // 평가 할당 컬렉션: 코드에서 evaluation_assignments 사용
    match /evaluation_assignments/{assignmentId} {
      allow read: if isTrustedUser();
      allow create: if isTrustedUser() || isAdmin();
      allow update: if isTrustedUser() || (request.auth.uid == resource.data.evaluatorId);
      allow delete: if isAdmin();
    }

    // 평가 결과 컬렉션
    match /evaluation_results/{resultId} {
      allow read: if isTrustedUser();
      allow create: if isTrustedUser();
      allow update: if isTrustedUser() || isAdmin();
    }

    // 평가 보정 컬렉션
    match /evaluation_adjustments/{adjustmentId} {
      allow read: if isTrustedUser();
      allow write: if isTrustedUser() || isAdmin();
    }

    // 사용자 컬렉션
    match /users/{userId} {
      allow read: if isTrustedUser() && (request.auth.uid == userId || isAdmin());
      allow write: if isTrustedUser() && request.auth.uid == userId;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
